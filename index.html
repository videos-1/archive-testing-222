<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProfileX - Creator Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 1.5rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 0.3rem;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .avatar-container {
      text-align: center;
      margin: 1rem 0;
    }

    .avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      border: 2px solid #1e293b;
      cursor: pointer;
      object-fit: cover;
      background: #0f172a;
    }

    .username-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .share-profile-btn {
      background: none;
      border: none;
      color: #60a5fa;
      cursor: pointer;
      font-size: 1.4rem;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .share-profile-btn:hover {
      color: #93c5fd;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1rem;
      max-width: 1200px;
      margin: auto;
    }

    .card {
      background: linear-gradient(135deg, #0f172a, #020617);
      border: 1px solid #1e293b;
      border-radius: 14px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      transition: transform 0.15s ease;
    }

    .card:hover {
      transform: scale(1.02);
    }

    .title {
      font-size: 0.9rem;
      font-weight: 600;
      word-break: break-all;
      color: #38bdf8;
    }

    .meta {
      font-size: 0.75rem;
      color: #94a3b8;
      line-height: 1.4;
    }

    .open-btn {
      margin-top: auto;
      padding: 0.6rem;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #1e293b;
      color: #e5e7eb;
      font-weight: 500;
    }

    .open-btn:hover {
      background: #334155;
    }

    .status {
      text-align: center;
      opacity: 0.85;
      margin-top: 2rem;
      font-size: 0.9rem;
    }

    .reviews-link {
      color: #60a5fa;
      text-decoration: none;
    }
    
    .reviews-link:hover {
      text-decoration: underline;
    }

    .fullscreen-overlay {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 999999;
      display: flex;
      flex-direction: column;
    }

    .close-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000000;
      background: rgba(255, 255, 255, 0.2);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      color: white;
    }

    .fullscreen-avatar {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      object-fit: contain;
    }

    .fullscreen-overlay iframe {
      width: 100vw;
      height: 100vh;
      border: 0;
    }
    
    .share-btn {
      background: none;
      border: none;
      color: #60a5fa;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      margin-left: 0.5rem;
    }
    
    .share-btn:hover {
      color: #93c5fd;
    }
    
    .preview-container {
      height: 150px;
      margin: 5px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .preview-placeholder {
      height: 100%;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 0.8rem;
    }
    
    .preview-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: auto;
      align-items: center;
    }
    
    .original-files-btn {
      background: none;
      border: none;
      color: #10b981;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      margin-left: 0.5rem;
      display: none; /* Hidden by default */
    }
    
    .original-files-btn:hover {
      color: #6ee7b7;
    }
    
    .description-full {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <h1>
    <span>ðŸ‘¤</span> ProfileX
  </h1>
  
  <div class="avatar-container">
    <img id="avatar" class="avatar" src="" alt="Profile Avatar" loading="lazy">
    <div class="username-container">
      <span id="username-display"></span>
      <button class="share-profile-btn" id="share-profile-btn">âž¦</button>
    </div>
  </div>

  <div class="subtitle" id="subtitle">Loading profile contentâ€¦</div>
  
  <div class="grid" id="grid"></div>
  <div class="status" id="status">Initializingâ€¦</div>

  <script>
    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const subtitle = document.getElementById("subtitle");
    const avatarImg = document.getElementById("avatar");
    const usernameDisplay = document.getElementById("username-display");
    const shareProfileBtn = document.getElementById("share-profile-btn");

    // Store all items for filtering
    let allItems = [];

    // IntersectionObserver for lazy loading previews
    const previewObserver = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;

        const container = entry.target;
        const embedUrl = container.dataset.embed;
        if (!embedUrl) return;

        container.innerHTML = `
          <iframe src="${embedUrl}" allow="autoplay; fullscreen"></iframe>
        `;

        previewObserver.unobserve(container);
      });
    }, {
      rootMargin: "200px",
      threshold: 0.1
    });

    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlUsername = urlParams.get('username');
    const urlIdentifier = urlParams.get('identifier');
    let fileParam = null;
    
    // Check for file parameter in the URL
    const fullPath = window.location.href;
    if (fullPath.includes('&file=')) {
      const fileMatch = fullPath.match(/&file=(.*)/);
      if (fileMatch) {
        fileParam = fileMatch[1];
      }
    }

    let username = urlUsername;
    let accountState = {};

    // Function to get avatar URL
    function getArchiveAvatar(username) {
      return `https://archive.org/services/img/@${username}`;
    }

    // Set avatar and username display
    if (username) {
      avatarImg.src = getArchiveAvatar(username);
      usernameDisplay.textContent = username;
    }

    // Initialize account state
    if (username) {
      accountState[username] = {
        page: 1,
        total: null,
        exhausted: false
      };
    }

    // Fullscreen avatar functionality
    avatarImg.addEventListener('click', () => {
      const overlay = document.createElement("div");
      overlay.className = "fullscreen-overlay";
      
      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.innerHTML = "âœ•";
      closeBtn.onclick = () => {
        document.body.removeChild(overlay);
      };
      
      const fullscreenImg = document.createElement("img");
      fullscreenImg.className = "fullscreen-avatar";
      fullscreenImg.src = avatarImg.src;
      fullscreenImg.alt = "Fullscreen Avatar";
      
      overlay.appendChild(closeBtn);
      overlay.appendChild(fullscreenImg);
      document.body.appendChild(overlay);
    });

    // Share profile functionality
    shareProfileBtn.addEventListener('click', () => {
      if (!username) return;
      
      const shareUrl = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-profile-page-shared-links-redirecting.html?username=${username}`;
      const shareText = `Check out ${username}'s profile: ${shareUrl}`;
      
      if (navigator.share) {
        navigator.share({
          title: `Profile: ${username}`,
          text: `Check out ${username}'s profile`,
          url: shareUrl
        }).catch(console.error);
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          alert("Profile link copied to clipboard!");
        }).catch(err => {
          console.error('Failed to copy: ', err);
          prompt("Copy this link to share:", shareText);
        });
      }
    });

    // Fetch metadata for a specific identifier
    async function fetchItemMetadata(identifier) {
      const api = `https://archive.org/metadata/${identifier}`;
      const res = await fetch(api);
      const data = await res.json();
      return data;
    }

    // Function to get original files count
    async function getOriginalFilesCount(identifier) {
      try {
        const res = await fetch(`https://archive.org/metadata/${identifier}`);
        const data = await res.json();

        if (!Array.isArray(data.files)) return 0;

        const mediatype = data.metadata?.mediatype;

        const formatsByType = {
          movies: ["mpeg4", "h.264", "matroska", "quicktime"],
          audio: ["mp3", "ogg", "flac", "wav", "aac"],
          texts: ["pdf", "djvu", "epub"],
          image: ["jpeg", "jpg", "png", "tiff"],
          software: ["zip", "iso", "exe"],
          data: ["zip", "csv", "json"]
        };

        const allowedFormats = formatsByType[mediatype] || [];

        const primaryFiles = data.files.filter(file => {
          if (file.source !== "original") return false;

          const format = (file.format || "").toLowerCase();
          if (!format) return false;

          return allowedFormats.some(f => format.includes(f));
        });

        return primaryFiles.length;
      } catch (e) {
        console.error(e);
        return 0;
      }
    }

    // Fetch items for a user
    async function fetchItems(username, page) {
      if (!accountState[username] || accountState[username].exhausted) return null;

      const state = accountState[username];
      
      let api = `https://archive.org/advancedsearch.php?q=creator:@${username}`;
      
      api += `&fl[]=identifier` +
        `&fl[]=title` +
        `&fl[]=creator` +
        `&fl[]=publicdate` +
        `&fl[]=mediatype` +
        `&fl[]=description` +
        `&fl[]=subject` +
        `&fl[]=gmail` +
        `&fl[]=link1` +
        `&fl[]=link2` +
        `&fl[]=link3` +
        `&fl[]=phone_number` +
        `&sort[]=publicdate desc` +
        `&rows=50` + // Increased rows to load more items at once
        `&page=${page}` +
        `&output=json`;

      const res = await fetch(api);
      const data = await res.json();

      if (state.total === null) {
        state.total = data.response.numFound;
        subtitle.textContent = `${username} (${state.total} items)`;
      }

      if (!data.response.docs.length) {
        state.exhausted = true;
        return null;
      }

      state.page++;
      return data.response.docs;
    }

    // Create card for item metadata
    function createMetadataCard(metadata) {
      const identifier = metadata.metadata.identifier;
      const title = metadata.metadata.title || identifier;
      const creator = metadata.metadata.creator || "Unknown";
      const date = metadata.metadata.publicdate || "N/A";
      const mediatype = metadata.metadata.mediatype || "unknown";
      const description = metadata.metadata.description ? metadata.metadata.description.toString() : "No description";
      
      // Extract subjects/tags
      let tags = "None";
      if (metadata.metadata.subject) {
        if (Array.isArray(metadata.metadata.subject)) {
          tags = metadata.metadata.subject.join(", ");
        } else {
          tags = metadata.metadata.subject.toString();
        }
      }
      
      const reviewUrl = `https://archive.org/details/${identifier}#reviews`;
      const embedUrl = `https://archive.org/embed/${identifier}`;
      const shareUrl = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-identifier-page-shared-links-redirecting.html?username=${username}&identifier=${identifier}`;

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.mediatype = mediatype;

      let metaHtml = `
        <div class="title">${title}</div>
        <div class="preview-container" data-embed="${embedUrl}">
          <div class="preview-placeholder">Preview</div>
        </div>
        <div class="meta"><b>Creator:</b> ${creator}</div>
        <div class="meta"><b>Date:</b> ${date}</div>
        <div class="meta"><b>Tags:</b> ${tags}</div>
        <div class="meta"><b>Media:</b> ${mediatype}</div>
        <div class="meta"><b>Description:</b> <div class="description-full">${description}</div></div>
      `;

      // Add optional fields only if they exist
      if (metadata.metadata.gmail) metaHtml += `<div class="meta"><b>Gmail:</b> ${metadata.metadata.gmail}</div>`;
      if (metadata.metadata.link1) metaHtml += `<div class="meta"><b>Link 1:</b> <a href="${metadata.metadata.link1}" target="_blank" style="color:#60a5fa;">${metadata.metadata.link1}</a></div>`;
      if (metadata.metadata.link2) metaHtml += `<div class="meta"><b>Link 2:</b> <a href="${metadata.metadata.link2}" target="_blank" style="color:#60a5fa;">${metadata.metadata.link2}</a></div>`;
      if (metadata.metadata.link3) metaHtml += `<div class="meta"><b>Link 3:</b> <a href="${metadata.metadata.link3}" target="_blank" style="color:#60a5fa;">${metadata.metadata.link3}</a></div>`;
      if (metadata.metadata.phone_number) metaHtml += `<div class="meta"><b>Phone:</b> ${metadata.metadata.phone_number}</div>`;

      metaHtml += `
        <div class="meta">
          <a href="${reviewUrl}" target="_blank" class="reviews-link">Reviews</a>
        </div>
        <div class="card-actions">
          <button class="open-btn" data-embed="${embedUrl}">Open Item</button>
          <button class="share-btn" data-share-url="${shareUrl}" data-title="${title}" data-creator="${creator}" data-description="${description}">á¯“âž¤</button>
        </div>
      `;

      card.innerHTML = metaHtml;

      card.querySelector(".open-btn").onclick = (e) => {
        const embedUrl = e.target.dataset.embed;
        openFullscreen(embedUrl);
      };

      card.querySelector(".share-btn").onclick = (e) => {
        const shareUrl = e.target.dataset.shareUrl;
        const title = e.target.dataset.title;
        const creator = e.target.dataset.creator;
        const description = e.target.dataset.description;
        
        const fullShareText = `Check out this item (${title}) by ${creator}: ${shareUrl} (${description})`;
        
        if (navigator.share) {
          navigator.share({
            title: title,
            text: `Check out this item (${title}) by ${creator}`,
            url: shareUrl
          }).catch(console.error);
        } else {
          navigator.clipboard.writeText(fullShareText).then(() => {
            alert("Share link copied to clipboard!");
          }).catch(err => {
            console.error('Failed to copy: ', err);
            prompt("Copy this link to share:", fullShareText);
          });
        }
      };

      // Observe preview for lazy loading
      const preview = card.querySelector(".preview-container");
      previewObserver.observe(preview);
      
      return card;
    }

    function createCard(identifier, metadata) {
      const title = metadata.title || identifier;
      const creator = metadata.creator || "Unknown";
      const date = metadata.publicdate || "N/A";
      const tags = metadata.subject ? metadata.subject.toString() : "None";
      const mediaType = metadata.mediatype || "unknown";
      const description = metadata.description ? metadata.description.toString() : "No description";
      const reviewUrl = `https://archive.org/details/${identifier}#reviews`;
      const embedUrl = `https://archive.org/embed/${identifier}`;
      const shareUrl = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-identifier-page-shared-links-redirecting.html?username=${username}&identifier=${identifier}`;

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.mediatype = mediaType;
      card.dataset.title = title.toLowerCase();
      card.dataset.tags = tags.toLowerCase();

      let metaHtml = `
        <div class="title">${title}</div>
        <div class="preview-container" data-embed="${embedUrl}">
          <div class="preview-placeholder">Preview</div>
        </div>
        <div class="meta"><b>Creator:</b> ${creator}</div>
        <div class="meta"><b>Date:</b> ${date}</div>
        <div class="meta"><b>Tags:</b> ${tags}</div>
        <div class="meta"><b>Media:</b> ${mediaType}</div>
        <div class="meta"><b>Description:</b> <div class="description-full">${description}</div></div>
      `;

      // Add optional fields only if they exist
      if (metadata.gmail) metaHtml += `<div class="meta"><b>Gmail:</b> ${metadata.gmail}</div>`;
      if (metadata.link1) metaHtml += `<div class="meta"><b>Link 1:</b> <a href="${metadata.link1}" target="_blank" style="color:#60a5fa;">${metadata.link1}</a></div>`;
      if (metadata.link2) metaHtml += `<div class="meta"><b>Link 2:</b> <a href="${metadata.link2}" target="_blank" style="color:#60a5fa;">${metadata.link2}</a></div>`;
      if (metadata.link3) metaHtml += `<div class="meta"><b>Link 3:</b> <a href="${metadata.link3}" target="_blank" style="color:#60a5fa;">${metadata.link3}</a></div>`;
      if (metadata.phone_number) metaHtml += `<div class="meta"><b>Phone:</b> ${metadata.phone_number}</div>`;

      metaHtml += `
        <div class="meta">
          <a href="${reviewUrl}" target="_blank" class="reviews-link">Reviews</a>
        </div>
        <div class="card-actions">
          <button class="open-btn" data-embed="${embedUrl}">Open Item</button>
          <button class="share-btn" data-share-url="${shareUrl}" data-title="${title}" data-creator="${creator}" data-description="${description}">á¯“âž¤</button>
          <button class="original-files-btn" data-identifier="${identifier}" data-username="${username}">á¯¤</button>
        </div>
      `;

      card.innerHTML = metaHtml;

      card.querySelector(".open-btn").onclick = (e) => {
        const embedUrl = e.target.dataset.embed;
        openFullscreen(embedUrl);
      };

      card.querySelector(".share-btn").onclick = (e) => {
        const shareUrl = e.target.dataset.shareUrl;
        const title = e.target.dataset.title;
        const creator = e.target.dataset.creator;
        const description = e.target.dataset.description;
        
        const fullShareText = `Check out this item (${title}) by ${creator}: ${shareUrl} (${description})`;
        
        if (navigator.share) {
          navigator.share({
            title: title,
            text: `Check out this item (${title}) by ${creator}`,
            url: shareUrl
          }).catch(console.error);
        } else {
          navigator.clipboard.writeText(fullShareText).then(() => {
            alert("Share link copied to clipboard!");
          }).catch(err => {
            console.error('Failed to copy: ', err);
            prompt("Copy this link to share:", fullShareText);
          });
        }
      };

      // Handle original files button click
      card.querySelector(".original-files-btn").onclick = (e) => {
        const identifier = e.target.dataset.identifier;
        const username = e.target.dataset.username;
        window.location.href = `items_playlist.html?username=${username}&identifier=${identifier}`;
      };

      // Store item for filtering
      allItems.push({
        element: card,
        mediatype: mediaType,
        title: title.toLowerCase(),
        tags: tags.toLowerCase(),
        originalFilesCount: metadata.originalFilesCount || 0
      });
      
      // Observe preview for lazy loading
      const preview = card.querySelector(".preview-container");
      previewObserver.observe(preview);
      
      return card;
    }

    async function renderItems(username, items) {
      if (!accountState[username]) return;
      
      const state = accountState[username];
      
      // Create document fragment for batch insert
      const fragment = document.createDocumentFragment();

      // Process items to get original files count
      const itemsWithCounts = await Promise.all(items.map(async (meta) => {
        const identifier = meta.identifier;
        const originalFilesCount = await getOriginalFilesCount(identifier);
        return { ...meta, originalFilesCount };
      }));

      // Create cards for all items
      itemsWithCounts.forEach((meta) => {
        const identifier = meta.identifier;
        const card = createCard(identifier, meta);
        
        // Show original files button if there are original files
        if (meta.originalFilesCount > 1) {
          const originalFilesBtn = card.querySelector(".original-files-btn");
          originalFilesBtn.style.display = "inline-block";
          originalFilesBtn.textContent = `á¯¤ ${meta.originalFilesCount}`;
        }
        
        fragment.appendChild(card);
      });

      // Append the entire batch
      grid.appendChild(fragment);
      
      // Update status
      status.textContent = `Loaded ${items.length} items`;
      
      // Hide load more button if exhausted
      if (state.exhausted) {
        status.textContent += " â€¢ All items loaded";
      }
    }

    // Fullscreen item functionality
    function openFullscreen(embedUrl) {
      document.body.style.overflow = "hidden";

      const overlay = document.createElement("div");
      overlay.className = "fullscreen-overlay";

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.innerHTML = "âœ•";
      closeBtn.onclick = () => {
        document.body.style.overflow = "";
        document.body.removeChild(overlay);
      };

      const embedContainer = document.createElement("div");
      embedContainer.className = "embed-container";
      embedContainer.style.flexGrow = "1";
      embedContainer.innerHTML = `
        <iframe
          src="${embedUrl}"
          allow="autoplay; fullscreen"
          style="width:100vw;height:100vh;border:0"
        ></iframe>
      `;

      overlay.appendChild(closeBtn);
      overlay.appendChild(embedContainer);
      document.body.appendChild(overlay);
    }

    // Initialize
    (async function init() {
      try {
        // If we have an identifier from URL, fetch and display its metadata first
        if (urlIdentifier) {
          status.textContent = "Loading item metadata...";
          const metadata = await fetchItemMetadata(urlIdentifier);
          
          if (metadata && metadata.metadata) {
            // Create and display the metadata card
            const metadataCard = createMetadataCard(metadata);
            grid.appendChild(metadataCard);
            
            // Set username from metadata if not already set
            if (!username && metadata.metadata.creator) {
              username = metadata.metadata.creator.replace(/^@/, ''); // Remove @ if present
              avatarImg.src = getArchiveAvatar(username);
              usernameDisplay.textContent = username;
              
              // Initialize account state
              accountState[username] = {
                page: 1,
                total: null,
                exhausted: false
              };
            }
            
            status.textContent = "Item metadata loaded";
          }
        }
        
        // If we have a username, load their items
        if (username) {
          const items = await fetchItems(username, 1);
          if (items) {
            await renderItems(username, items);
          } else {
            status.textContent = "No items found for this profile";
          }
        } else {
          status.textContent = "No valid username or identifier provided";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "Error while loading profile content.";
      }
    })();
  </script>

</body>
</html>
