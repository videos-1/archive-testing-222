
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Item Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --border:#334155;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
}

body{
  margin:0;
  font-family:system-ui, monospace;
  background:var(--bg);
  color:var(--text);
}

header{
  text-align:center;
  padding:1rem;
  border-bottom:1px solid var(--border);
  position:relative;
}

button{
  background:#1e293b;
  color:var(--text);
  border:none;
  padding:0.45rem 0.9rem;
  border-radius:6px;
  cursor:pointer;
}

#backBtn{
  position:absolute;
  left:1rem;
  top:50%;
  transform:translateY(-50%);
}

.search-container {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  justify-content: center;
}

.search-container input {
  padding: 0.5rem;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  width: 100%;
  max-width: 400px;
}

.refresh-link {
  display: inline-block;
  margin-top: 0.5rem;
  color: var(--accent);
  cursor: pointer;
  font-size: 0.9rem;
}

.refresh-link:hover {
  text-decoration: underline;
}

.viewer{
  padding:1rem;
  display:flex;
  flex-direction:column;
  gap:1rem;
}

.player{
  width:100%;
  height:420px;
  border:1px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  background:#1e293b;
}

.player iframe{
  width:100%;
  height:100%;
  border:none;
}

.info{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:1rem;
}

.info h3{
  margin:0 0 0.5rem 0;
  color:var(--accent);
}

.meta{
  font-size:0.85rem;
  color:var(--muted);
}

/* Grid Styles */
.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
  padding: 1rem;
}

.grid-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.2s;
  position: relative;
}

.grid-item:hover {
  transform: translateY(-5px);
}

.fullscreen-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(30, 41, 59, 0.8);
  color: var(--accent);
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 4px;
  cursor: pointer;
  z-index: 10;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.media {
  width: 100%;
  height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #1e293b;
  position: relative;
}

.media iframe,
.media video,
.media img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border: none;
}

.grid-item .file-info {
  padding: 0.75rem;
}

.grid-item .file-name {
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 0.25rem;
  word-break: break-all;
}

.grid-item .file-meta {
  font-size: 0.8rem;
  color: var(--muted);
}

.grid-item .file-meta .share-symbol {
  color: var(--accent);
  cursor: pointer;
  margin-left: 5px;
}

@media (max-width:768px){
  .player{ height:260px; }
  .grid-container {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<header>
  <button id="backBtn" onclick="goBack()">← Back</button>
  <h2 id="pageTitle">Item Viewer</h2>
  <div class="meta" id="creatorLine"></div>
  
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search files by name...">
    <button id="searchBtn">Search</button>
  </div>
  <div class="refresh-link" onclick="refreshDisplay()">Refresh</div>
</header>

<div class="viewer">
  <div class="player">
    <iframe id="playerFrame" allowfullscreen></iframe>
  </div>

  <div class="info">
    <h3 id="itemTitle">Loading…</h3>
    <div class="meta" id="itemMeta"></div>
  </div>
  
  <div class="grid-container" id="filesGrid"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const username = params.get("username");
const identifier = params.get("identifier");

const playerFrame = document.getElementById("playerFrame");
const itemTitle = document.getElementById("itemTitle");
const itemMeta = document.getElementById("itemMeta");
const pageTitle = document.getElementById("pageTitle");
const creatorLine = document.getElementById("creatorLine");
const filesGrid = document.getElementById("filesGrid");
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");

let allFiles = []; // Store all files for search/refresh

function goBack(){
  window.history.back();
}

// Universal embed URL helper
function archiveEmbedUrl(identifier, fileName) {
  return `https://archive.org/embed/${identifier}/${encodeURIComponent(fileName)}`;
}

// Create appropriate HTML element based on file type
function createFileElement(file) {
  const embedUrl = archiveEmbedUrl(identifier, file.name);
  const ext = file.name.split('.').pop().toLowerCase();

  // VIDEO
  if (['mp4','m4v','webm','ogv'].includes(ext)) {
    return `
      <iframe
        src="${embedUrl}"
        allowfullscreen
        loading="lazy"
      ></iframe>
    `;
  }

  // AUDIO
  if (['mp3','wav','ogg','flac','m4a'].includes(ext)) {
    return `
      <iframe
        src="${embedUrl}"
        loading="lazy"
      ></iframe>
    `;
  }

  // IMAGE
  if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
    return `
      <iframe
        src="${embedUrl}"
        loading="lazy"
      ></iframe>
    `;
  }

  // PDF - use Google Docs Viewer
  if (ext === 'pdf') {
    const downloadUrl = `https://archive.org/download/${identifier}/${encodeURIComponent(file.name)}`;
    const googleViewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(downloadUrl)}&embedded=true`;
    return `
      <iframe
        src="${googleViewerUrl}"
        loading="lazy"
      ></iframe>
    `;
  }

  // TEXT (best possible preview)
  if (['txt','md','csv','json','log'].includes(ext)) {
    return `
      <iframe
        src="${embedUrl}"
        loading="lazy"
      ></iframe>
    `;
  }

  // UNSUPPORTED → no preview
  return `
    <div style="color:#94a3b8;font-size:0.85rem;">
      Preview not available
    </div>
  `;
}

// Open file in true fullscreen
function openFullscreen(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  let embedUrl;

  // For PDF, use Google Docs Viewer in fullscreen
  if (ext === 'pdf') {
    const downloadUrl = `https://archive.org/download/${identifier}/${encodeURIComponent(file.name)}`;
    embedUrl = `https://docs.google.com/gview?url=${encodeURIComponent(downloadUrl)}&embedded=true`;
  } else {
    embedUrl = archiveEmbedUrl(identifier, file.name);
  }

  const iframe = document.createElement('iframe');
  iframe.src = embedUrl;
  iframe.allowFullscreen = true;

  iframe.style.width = '100vw';
  iframe.style.height = '100vh';
  iframe.style.border = 'none';
  iframe.style.background = '#000';

  document.body.appendChild(iframe);

  if (iframe.requestFullscreen) {
    iframe.requestFullscreen();
  }

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      iframe.remove();
    }
  }, { once: true });
}

// Share item
function shareItem(title, username, identifier, fileName) {
  const shareUrl =
    `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-identifier-page-shared-links-redirecting.html` +
    `?username=${encodeURIComponent(username)}` +
    `&identifier=${encodeURIComponent(identifier)}` +
    `&file=${encodeURIComponent(fileName)}`;

  const shareText = `Check out "${fileName}" from "${title}" by ${username}`;

  if (navigator.share) {
    navigator.share({
      title: fileName,
      text: shareText,
      url: shareUrl
    }).catch(console.error);
  } else {
    navigator.clipboard.writeText(shareUrl).then(() => {
      alert('Link copied to clipboard!');
    }).catch(() => {
      prompt('Copy this link:', shareUrl);
    });
  }
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Parse date for sorting
function parseDate(dateStr) {
  if (!dateStr) return new Date(0);
  // Handle various date formats
  const parsed = new Date(dateStr);
  return isNaN(parsed.getTime()) ? new Date(0) : parsed;
}

// Display files (with optional filter)
function displayFiles(filesToShow) {
  // Clear previous grid content
  filesGrid.innerHTML = '';

  if(filesToShow.length === 0) {
    filesGrid.innerHTML = '<p>No files found</p>';
    return;
  }

  // Create grid items
  filesToShow.forEach(file => {
    const gridItem = document.createElement('div');
    gridItem.className = 'grid-item';
    
    const fileSize = formatFileSize(file.size);
    const fileDate = file.dateObj.toISOString().split('T')[0]; // Format as YYYY-MM-DD
    
    gridItem.innerHTML = `
      <button class="fullscreen-btn" title="View Fullscreen">⛶</button>
      <div class="media">
        ${createFileElement(file)}
      </div>
      <div class="file-info">
        <div class="file-name">${file.name}</div>
        <div class="file-meta">${file.format} • ${fileSize} • ${fileDate} <span class="share-symbol" title="Share">ᯓ➤</span></div>
      </div>
    `;
    
    filesGrid.appendChild(gridItem);
    
    // Add event listener to fullscreen button
    gridItem.querySelector('.fullscreen-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      openFullscreen(file);
    });
    
    // Add event listener to share symbol
    gridItem.querySelector('.share-symbol').addEventListener('click', (e) => {
      e.stopPropagation();
      const title = document.getElementById("itemTitle").textContent;
      const user = username || "Unknown";
      shareItem(title, user, identifier, file.name);
    });
  });
}

// Search files by name
function searchFiles() {
  const searchTerm = searchInput.value.toLowerCase();
  if (!searchTerm) {
    displayFiles(allFiles); // Show all if search is empty
    return;
  }
  
  const filteredFiles = allFiles.filter(file => 
    file.name.toLowerCase().includes(searchTerm)
  );
  
  displayFiles(filteredFiles);
}

// Refresh display (show all files)
function refreshDisplay() {
  searchInput.value = '';
  displayFiles(allFiles);
}

async function loadItem(){
  if(!identifier){
    itemTitle.textContent = "No item selected";
    return;
  }

  pageTitle.textContent = identifier;
  creatorLine.textContent = username ? `Creator: ${username}` : "";

  playerFrame.src = `https://archive.org/embed/${identifier}`;

  try{
    const res = await fetch(`https://archive.org/metadata/${identifier}`);
    const data = await res.json();
    const meta = data.metadata || {};
    const files = data.files || [];

    itemTitle.textContent = meta.title || identifier;

    const date = meta.date || meta.year || "Unknown date";
    const type = meta.mediatype || "Unknown type";
    const creator = meta.creator || username || "Unknown";

    itemMeta.textContent = `${type} • ${creator} • ${date}`;

    // Filter original files (smart filtering + exclude MKV)
    const originalFiles = files.filter(f =>
      f.source === 'original' &&
      f.name &&
      !f.name.startsWith('.') &&
      !f.name.match(/\.(torrent|sqlite|xml|jsonl|log|conf|md5|sha1|sha256)$/i) &&
      !f.name.includes('_meta') &&
      !f.name.includes('_rules') &&
      !f.name.toLowerCase().endsWith('.mkv')
    );

    // Extract dates for files and sort by newest first
    allFiles = originalFiles.map(file => {
      // Try to get date from file metadata
      const fileDate = file.mtime ? new Date(file.mtime * 1000) : 
                      file.date ? parseDate(file.date) : new Date(0);
      return {
        ...file,
        dateObj: fileDate
      };
    });

    // Sort by date (newest first)
    allFiles.sort((a, b) => b.dateObj - a.dateObj);

    // Initial display
    displayFiles(allFiles);
    
    // Setup search event listeners
    searchBtn.addEventListener('click', searchFiles);
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') searchFiles();
    });
    
  }catch(err){
    console.error(err);
    itemTitle.textContent = identifier;
    itemMeta.textContent = "Metadata unavailable";
    filesGrid.innerHTML = '<p>Error loading files</p>';
  }
}

loadItem();
</script>

</body>
</html>
